# Cloudflare Tunnel Setup Guide

## Prerequisites

- Cloudflare account (free tier works)
- Domain added to Cloudflare
- GitHub repository secrets access

## Step 1: Find Your Account ID

1. Log into Cloudflare Dashboard
2. Click on any website in your account
3. Scroll down in the right sidebar
4. Look for **Account ID** - copy this value

## Step 2: Create API Token with Correct Permissions

1. Go to: https://dash.cloudflare.com/profile/api-tokens
2. Click **"Create Token"**
3. Click **"Create Custom Token"**

### Configure Token Permissions:

**Account Permissions** (REQUIRED):
- Account → Cloudflare Tunnel → Edit

**Zone Permissions** (REQUIRED):
- Zone → DNS → Edit
- Zone Resources → Include → Specific zone → [Select your domain]

**Token Name**: `vibe-in-vps-tunnel` (or any name you prefer)

4. Click **"Continue to summary"**
5. Click **"Create Token"**
6. **COPY THE TOKEN** (you won't see it again!)

## Step 3: Verify Token Works (Optional but Recommended)

Test your token locally before adding to GitHub:

```bash
# Set environment variables
export CLOUDFLARE_API_TOKEN="your-token-here"
export CLOUDFLARE_ACCOUNT_ID="your-account-id-here"

# Test: List tunnels (should return empty list or existing tunnels, not an error)
curl -X GET "https://api.cloudflare.com/client/v4/accounts/${CLOUDFLARE_ACCOUNT_ID}/cfd_tunnel" \
  -H "Authorization: Bearer ${CLOUDFLARE_API_TOKEN}" \
  -H "Content-Type: application/json"
```

**Expected response**: JSON with `"success": true` (even if tunnels array is empty)
**Error response**: `"success": false` with error code 10000 = token permissions problem

## Step 4: Add Secrets to GitHub

Go to: Repository → Settings → Secrets and variables → Actions

Add these secrets:

### Required Secrets:

**CLOUDFLARE_API_TOKEN**
- Value: The token you created in Step 2
- Used for: Creating tunnel and DNS records

**CLOUDFLARE_ACCOUNT_ID**
- Value: The Account ID from Step 1
- Used for: Identifying which Cloudflare account to use

### Auto-Generated (After Infrastructure Workflow):

These will be shown in the workflow output after running "Provision Infrastructure":
- `CLOUDFLARE_TUNNEL_TOKEN` - Generated by Terraform
- `CUSTOM_DOMAIN_URL` - Your custom domain URL

## Step 5: Run Infrastructure Workflow

1. Go to: Actions → "Provision Infrastructure" → Run workflow
2. Wait for completion
3. Copy `CLOUDFLARE_TUNNEL_TOKEN` from workflow output
4. Add it as a GitHub Secret

## Step 6: Enable cloudflared Service

Edit `deploy/docker-compose.yml` and uncomment the cloudflared service:

```yaml
# Find this section and uncomment:
# [CLOUDFLARE_START]
cloudflared:
  image: cloudflare/cloudflare:latest
  # ... rest of config
# [CLOUDFLARE_END]
```

Or use the setup wizard: `node scripts/setup-wizard.js` → Step 6 → Press E → Press C

## Step 7: Deploy

Push to main branch to trigger deployment.

Your app will be available at: `https://your-domain.com`

---

## Common Issues

### "Authentication error (10000)"

**Cause**: API token doesn't have required permissions or is scoped to wrong account

**Solution**:
1. Verify token has BOTH Account (Tunnel Edit) AND Zone (DNS Edit) permissions
2. Verify Account ID matches the account where your domain is hosted
3. Create a new token following Step 2 above
4. Update `CLOUDFLARE_API_TOKEN` secret in GitHub

### "Account ID not found"

**Cause**: Wrong Account ID or token not scoped to that account

**Solution**:
1. Double-check Account ID from Cloudflare dashboard
2. Ensure token is created in the same account as your domain
3. Update `CLOUDFLARE_ACCOUNT_ID` secret in GitHub

### "Zone not found"

**Cause**: Zone ID doesn't match your domain or token doesn't have Zone permissions

**Solution**:
1. Go to Cloudflare dashboard → Select your domain
2. Copy **Zone ID** from right sidebar
3. Update `cloudflare_zone_id` in `infra/terraform/terraform.tfvars`
4. Ensure token has Zone → DNS → Edit permission for this specific zone

### "Tunnel already exists"

**Cause**: Previous terraform apply created a tunnel but failed later

**Solution**:
1. Go to Cloudflare dashboard → Zero Trust → Networks → Tunnels
2. Delete the existing tunnel
3. Re-run "Provision Infrastructure" workflow

---

## Permissions Summary

Your API token needs:

| Permission Type | Permission | Access Level |
|----------------|------------|--------------|
| Account | Cloudflare Tunnel | Edit |
| Zone | DNS | Edit |

Zone should be scoped to your specific domain (not "All zones").

---

## Testing Locally (Optional)

If you want to test Terraform locally before GitHub Actions:

```bash
# Set environment variables
export TF_VAR_hcloud_token="your-hetzner-token"
export TF_VAR_cloudflare_api_token="your-cloudflare-token"
export TF_VAR_cloudflare_account_id="your-account-id"
export TF_VAR_ssh_public_key="$(cat ~/.ssh/id_ed25519.pub)"
export TF_VAR_github_repository="username/repo"

# Run Terraform
cd infra/terraform
terraform init
terraform plan
```

This lets you verify the Cloudflare configuration works before committing to GitHub.
