name: Initial VPS Setup

on:
  workflow_dispatch:
    inputs:
      destroy:
        description: 'Destroy infrastructure instead of creating it'
        required: false
        type: boolean
        default: false

jobs:
  terraform:
    name: Provision Infrastructure
    runs-on: ubuntu-latest
    outputs:
      vps_host: ${{ steps.tf_output.outputs.vps_host }}
      healthcheck_ping_url: ${{ steps.tf_output.outputs.healthcheck_ping_url }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: "1.6.0"
          terraform_wrapper: false

      - name: Restore Terraform State
        uses: dawidd6/action-download-artifact@v3
        continue-on-error: true
        with:
          workflow: setup.yml
          name: terraform-state
          path: infra/terraform/
          if_no_artifact_found: warn

      - name: Create terraform.tfvars from secrets
        working-directory: infra/terraform
        run: |
          cat > terraform.tfvars <<EOF
          hcloud_token         = "${{ secrets.HETZNER_TOKEN }}"
          healthchecks_api_key = "${{ secrets.HEALTHCHECKS_API_KEY }}"
          ssh_public_key       = "${{ secrets.SSH_PUBLIC_KEY }}"
          github_repository    = "${{ github.repository }}"
          EOF

      - name: Terraform Init
        working-directory: infra/terraform
        run: terraform init

      - name: Terraform Validate
        working-directory: infra/terraform
        run: terraform validate

      - name: Terraform Plan
        if: ${{ !inputs.destroy }}
        working-directory: infra/terraform
        run: terraform plan

      - name: Terraform Apply
        if: ${{ !inputs.destroy }}
        working-directory: infra/terraform
        run: terraform apply -auto-approve

      - name: Terraform Destroy
        if: ${{ inputs.destroy }}
        working-directory: infra/terraform
        run: terraform destroy -auto-approve

      - name: Extract Terraform Outputs
        if: ${{ !inputs.destroy }}
        id: tf_output
        working-directory: infra/terraform
        run: |
          VPS_HOST=$(terraform output -raw server_ip)
          HEALTHCHECK_URL=$(terraform output -raw healthcheck_ping_url)

          echo "vps_host=$VPS_HOST" >> $GITHUB_OUTPUT
          echo "healthcheck_ping_url=$HEALTHCHECK_URL" >> $GITHUB_OUTPUT

          echo "### Terraform Outputs" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**VPS IP Address:** \`$VPS_HOST\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**SSH Command:** \`ssh deploy@$VPS_HOST\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**App URL:** http://$VPS_HOST" >> $GITHUB_STEP_SUMMARY

      - name: Save Terraform State
        if: ${{ !inputs.destroy && success() }}
        uses: actions/upload-artifact@v4
        with:
          name: terraform-state
          path: infra/terraform/terraform.tfstate
          retention-days: 90
          overwrite: true

      - name: Display secrets configuration instructions
        if: ${{ !inputs.destroy }}
        env:
          VPS_HOST: ${{ steps.tf_output.outputs.vps_host }}
          HEALTHCHECK_URL: ${{ steps.tf_output.outputs.healthcheck_ping_url }}
        run: |
          echo "### âš ï¸ Action Required: Configure Deployment Secrets" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Add these secrets to enable automatic deployments:" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Go to: **Settings â†’ Secrets and variables â†’ Actions â†’ New repository secret**" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Required secret:**" >> $GITHUB_STEP_SUMMARY
          echo "- Name: \`VPS_HOST\`" >> $GITHUB_STEP_SUMMARY
          echo "- Value: \`$VPS_HOST\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [ -n "$HEALTHCHECK_URL" ]; then
            echo "**Optional secret (for monitoring):**" >> $GITHUB_STEP_SUMMARY
            echo "- Name: \`HEALTHCHECK_PING_URL\`" >> $GITHUB_STEP_SUMMARY
            echo "- Value: \`$HEALTHCHECK_URL\`" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
          fi

          echo "---" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "After adding these secrets, automatic deployments will work on push to main." >> $GITHUB_STEP_SUMMARY

  bootstrap:
    name: Bootstrap VPS
    needs: terraform
    if: ${{ !inputs.destroy }}
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Wait for VPS to be ready
        run: |
          echo "Waiting for VPS to accept SSH connections..."
          VPS_HOST="${{ needs.terraform.outputs.vps_host }}"

          for i in {1..60}; do
            if nc -z -w5 $VPS_HOST 22; then
              echo "âœ… VPS is accepting SSH connections!"
              sleep 30  # Give cloud-init more time to complete
              exit 0
            fi
            echo "Attempt $i/60 - waiting for SSH on $VPS_HOST..."
            sleep 10
          done

          echo "âŒ Could not connect to VPS after 10 minutes"
          exit 1

      - name: Setup SSH
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.SSH_PRIVATE_KEY }}" > ~/.ssh/deploy_key
          chmod 600 ~/.ssh/deploy_key
          ssh-keyscan -H ${{ needs.terraform.outputs.vps_host }} >> ~/.ssh/known_hosts

      - name: Wait for cloud-init to complete
        run: |
          ssh -i ~/.ssh/deploy_key -o StrictHostKeyChecking=no deploy@${{ needs.terraform.outputs.vps_host }} << 'EOF'
            echo "Waiting for cloud-init to complete..."

            MAX_WAIT=600
            ELAPSED=0
            while [ ! -f /opt/app/.cloud-init-complete ]; do
              if [ $ELAPSED -ge $MAX_WAIT ]; then
                echo "ERROR: cloud-init did not complete within ${MAX_WAIT}s"
                exit 1
              fi
              echo "  Still waiting... (${ELAPSED}s)"
              sleep 10
              ELAPSED=$((ELAPSED + 10))
            done

            echo "âœ… cloud-init complete!"
            docker --version
            docker compose version
          EOF

      - name: Copy deployment files to VPS
        run: |
          scp -i ~/.ssh/deploy_key deploy/docker-compose.yml deploy@${{ needs.terraform.outputs.vps_host }}:/opt/app/
          scp -i ~/.ssh/deploy_key deploy/bootstrap.sh deploy@${{ needs.terraform.outputs.vps_host }}:/opt/app/
          scp -i ~/.ssh/deploy_key deploy/update.sh deploy@${{ needs.terraform.outputs.vps_host }}:/opt/app/

      - name: Run bootstrap script
        run: |
          ssh -i ~/.ssh/deploy_key deploy@${{ needs.terraform.outputs.vps_host }} << 'EOF'
            export GITHUB_REPOSITORY=${{ github.repository }}
            export GITHUB_TOKEN=${{ secrets.GITHUB_TOKEN }}
            export GITHUB_ACTOR=${{ github.actor }}

            cd /opt/app
            chmod +x bootstrap.sh
            ./bootstrap.sh
          EOF

      - name: Verify setup
        run: |
          ssh -i ~/.ssh/deploy_key deploy@${{ needs.terraform.outputs.vps_host }} << 'EOF'
            echo "=== System Info ==="
            docker --version
            docker compose version
            echo ""
            echo "=== Running Containers ==="
            docker compose ps
            echo ""
            echo "=== Recent Logs ==="
            docker compose logs --tail=30 app
          EOF

      - name: Ping healthcheck
        if: success()
        env:
          HEALTHCHECK_URL: ${{ needs.terraform.outputs.healthcheck_ping_url }}
        run: |
          if [ -n "$HEALTHCHECK_URL" ]; then
            curl -fsS --retry 3 "$HEALTHCHECK_URL" > /dev/null && echo "âœ“ healthchecks.io pinged"
          else
            echo "â„¹ healthchecks.io monitoring disabled (no HEALTHCHECK_PING_URL configured)"
          fi

      - name: Display access information
        run: |
          echo "### ðŸŽ‰ Setup Complete!" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Your app is now deployed and running!" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Access your app:** http://${{ needs.terraform.outputs.vps_host }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**SSH access:** \`ssh deploy@${{ needs.terraform.outputs.vps_host }}\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**View logs:** \`ssh deploy@${{ needs.terraform.outputs.vps_host }} 'docker compose logs -f'\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Monitor uptime:** [healthchecks.io](https://healthchecks.io/projects/)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "---" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Next steps:**" >> $GITHUB_STEP_SUMMARY
          echo "1. Push changes to \`main\` branch to trigger automatic deployments" >> $GITHUB_STEP_SUMMARY
          echo "2. Replace the example app in \`/app\` with your own application" >> $GITHUB_STEP_SUMMARY
          echo "3. Configure alert channels in healthchecks.io dashboard" >> $GITHUB_STEP_SUMMARY

      - name: Cleanup SSH key
        if: always()
        run: rm -f ~/.ssh/deploy_key
