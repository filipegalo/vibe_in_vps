name: Deploy to VPS

on:
  push:
    branches:
      - main
    paths:
      - 'app/**'
      - 'deploy/**'
      - '.github/workflows/deploy.yml'
  workflow_dispatch:

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository }}

jobs:
  build:
    name: Build and Push Docker Image
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Extract metadata
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}
          tags: |
            type=sha,prefix={{branch}}-
            type=raw,value=latest,enable={{is_default_branch}}

      - name: Build and push Docker image
        uses: docker/build-push-action@v5
        with:
          context: ./app
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

  deploy:
    name: Deploy to VPS
    needs: build
    runs-on: ubuntu-latest
    permissions:
      contents: read
      deployments: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Verify Setup Complete
        run: |
          if [ -z "${{ secrets.VPS_HOST }}" ]; then
            echo "❌ ERROR: VPS not configured!"
            echo ""
            echo "This workflow requires initial setup to be completed first."
            echo ""
            echo "Please follow these steps:"
            echo "1. Go to Actions → Provision Infrastructure"
            echo "2. Run the setup workflow"
            echo "3. Wait for it to complete successfully"
            echo ""
            echo "After setup completes, this workflow will run automatically on future pushes."
            exit 1
          fi
          echo "✓ Setup verified - VPS_HOST configured"

      - name: Create GitHub Deployment
        id: deployment
        uses: chrnorm/deployment-action@v2
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          environment: production
          environment-url: http://${{ secrets.VPS_HOST }}
          ref: ${{ github.sha }}

      - name: Setup SSH
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.SSH_PRIVATE_KEY }}" > ~/.ssh/deploy_key
          chmod 600 ~/.ssh/deploy_key
          ssh-keyscan -H ${{ secrets.VPS_HOST }} >> ~/.ssh/known_hosts

      - name: Copy deployment files to VPS
        run: |
          scp -i ~/.ssh/deploy_key deploy/docker-compose.yml ${{ secrets.VPS_USER }}@${{ secrets.VPS_HOST }}:/opt/app/
          scp -i ~/.ssh/deploy_key deploy/update.sh ${{ secrets.VPS_USER }}@${{ secrets.VPS_HOST }}:/opt/app/

          # Copy backup script if it exists
          if [ -f deploy/scripts/db-backup.sh ]; then
            ssh -i ~/.ssh/deploy_key ${{ secrets.VPS_USER }}@${{ secrets.VPS_HOST }} 'mkdir -p /opt/app/scripts'
            scp -i ~/.ssh/deploy_key deploy/scripts/db-backup.sh ${{ secrets.VPS_USER }}@${{ secrets.VPS_HOST }}:/opt/app/scripts/
            ssh -i ~/.ssh/deploy_key ${{ secrets.VPS_USER }}@${{ secrets.VPS_HOST }} 'chmod +x /opt/app/scripts/db-backup.sh'
          fi

      - name: Deploy application
        run: |
          ssh -i ~/.ssh/deploy_key ${{ secrets.VPS_USER }}@${{ secrets.VPS_HOST }} << 'EOF'
            export GITHUB_REPOSITORY=${{ github.repository }}
            export GITHUB_TOKEN=${{ secrets.GITHUB_TOKEN }}
            export GITHUB_ACTOR=${{ github.actor }}

            # Export database credentials if configured
            export POSTGRES_USER="${POSTGRES_USER:-app}"
            export POSTGRES_PASSWORD="${POSTGRES_PASSWORD}"
            export POSTGRES_DB="${POSTGRES_DB:-app}"
            export MYSQL_ROOT_PASSWORD="${MYSQL_ROOT_PASSWORD}"
            export MYSQL_USER="${MYSQL_USER:-app}"
            export MYSQL_PASSWORD="${MYSQL_PASSWORD:-${MYSQL_ROOT_PASSWORD}}"
            export MYSQL_DATABASE="${MYSQL_DATABASE:-app}"
            export REDIS_PASSWORD="${REDIS_PASSWORD}"

            cd /opt/app
            chmod +x update.sh
            ./update.sh
          EOF
        env:
          POSTGRES_PASSWORD: ${{ secrets.POSTGRES_PASSWORD }}
          MYSQL_ROOT_PASSWORD: ${{ secrets.MYSQL_ROOT_PASSWORD }}
          REDIS_PASSWORD: ${{ secrets.REDIS_PASSWORD }}

      - name: Ping healthcheck
        if: success()
        env:
          HEALTHCHECK_URL: ${{ secrets.HEALTHCHECK_PING_URL }}
        run: |
          if [ -n "$HEALTHCHECK_URL" ]; then
            curl -fsS --retry 3 "$HEALTHCHECK_URL" > /dev/null && echo "✓ healthchecks.io pinged"
          else
            echo "ℹ healthchecks.io monitoring disabled (no HEALTHCHECK_PING_URL configured)"
          fi

      - name: Verify deployment
        run: |
          ssh -i ~/.ssh/deploy_key ${{ secrets.VPS_USER }}@${{ secrets.VPS_HOST }} << 'EOF'
            cd /opt/app
            docker compose ps
            docker compose logs --tail=50 app
          EOF

      - name: Update deployment status (success)
        if: success()
        uses: chrnorm/deployment-status@v2
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          deployment-id: ${{ steps.deployment.outputs.deployment_id }}
          state: success
          environment-url: http://${{ secrets.VPS_HOST }}

      - name: Update deployment status (failure)
        if: failure()
        uses: chrnorm/deployment-status@v2
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          deployment-id: ${{ steps.deployment.outputs.deployment_id }}
          state: failure

      - name: Cleanup SSH key
        if: always()
        run: rm -f ~/.ssh/deploy_key
